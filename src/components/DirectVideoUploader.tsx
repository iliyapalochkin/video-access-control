import React, { useState, useRef } from 'react';
import Icon from '@/components/ui/icon';

interface DirectVideoUploaderProps {
  onVideoSelect: (videoUrl: string) => void;
}

const DirectVideoUploader: React.FC<DirectVideoUploaderProps> = ({ onVideoSelect }) => {
  const [isUploading, setIsUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState(0);
  const [currentFile, setCurrentFile] = useState<File | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
    if (!file.type.startsWith('video/')) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ—Ñ–∞–π–ª');
      return;
    }

    setCurrentFile(file);
    handleDirectUpload(file);
  };

  const formatFileSize = (bytes: number): string => {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  };

  const saveToIndexedDB = async (file: File): Promise<void> => {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open('VideoStorage', 1);
      
      request.onerror = () => reject(request.error);
      
      request.onupgradeneeded = (event) => {
        const db = (event.target as IDBOpenDBRequest).result;
        if (!db.objectStoreNames.contains('videos')) {
          db.createObjectStore('videos');
        }
      };
      
      request.onsuccess = () => {
        const db = request.result;
        const transaction = db.transaction(['videos'], 'readwrite');
        const store = transaction.objectStore('videos');
        
        const videoData = {
          name: file.name,
          size: file.size,
          type: file.type,
          file: file,
          uploadDate: new Date().toISOString()
        };
        
        const putRequest = store.put(videoData, 'siteVideo');
        
        putRequest.onsuccess = () => {
          db.close();
          resolve();
        };
        
        putRequest.onerror = () => {
          db.close();
          reject(putRequest.error);
        };
      };
    });
  };

  const handleDirectUpload = async (file: File) => {
    setIsUploading(true);
    setUploadProgress(0);

    try {
      const fileSize = file.size;
      const maxSize = 2 * 1024 * 1024 * 1024; // 2GB –º–∞–∫—Å–∏–º—É–º
      
      setUploadProgress(10);
      
      if (fileSize > maxSize) {
        alert(`‚ö†Ô∏è –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (${formatFileSize(fileSize)})!\n\n–ú–∞–∫—Å–∏–º—É–º: 2GB\n\nüí° –î–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∫–ª–∞–¥–∫—É "üîó –ü–æ —Å—Å—ã–ª–∫–µ" –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–∞ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ`);
        return;
      }
      
      setUploadProgress(30);
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ IndexedDB (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã)
      await saveToIndexedDB(file);
      setUploadProgress(70);
      
      // –°–æ–∑–¥–∞–µ–º URL –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
      const videoUrl = URL.createObjectURL(file);
      setUploadProgress(100);
      
      // –ü–µ—Ä–µ–¥–∞–µ–º URL –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
      onVideoSelect(videoUrl);
      
      alert(`‚úÖ –í–∏–¥–µ–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É!\n–†–∞–∑–º–µ—Ä: ${formatFileSize(fileSize)}\n–§–æ—Ä–º–∞—Ç: ${file.type}\n\n‚ú® –í–∏–¥–µ–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∏ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–∏—Ö –ø–æ—Å–µ—â–µ–Ω–∏—è—Ö!\nüé¨ –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Safari –Ω–∞ iPhone!`);
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
      alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∏–¥–µ–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
    } finally {
      setIsUploading(false);
      setUploadProgress(0);
    }
  };

  return (
    <div className="w-full max-w-md mx-auto">
      <div className="bg-gradient-to-br from-blue-50 to-purple-50 rounded-lg p-6 border-2 border-dashed border-blue-300 hover:border-blue-500 transition-colors">
        <div className="text-center">
          <Icon name="Upload" size={48} className="mx-auto mb-4 text-blue-500" />
          
          <h3 className="text-lg font-semibold mb-2 text-gray-800">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h3>
          
          <p className="text-gray-600 mb-4 text-sm">
            ‚úÖ <span className="text-green-600 font-medium">–í–∏–¥–µ–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ</span><br/>
            <span className="text-gray-500">–†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –≤–∫–ª—é—á–∞—è Safari –Ω–∞ iPhone</span>
          </p>

          {isUploading ? (
            <div className="mb-4">
              <div className="w-full bg-gray-200 rounded-full h-3 mb-2">
                <div 
                  className="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all duration-300"
                  style={{ width: `${uploadProgress}%` }}
                ></div>
              </div>
              <p className="text-sm text-gray-700 font-medium">
                –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤–∏–¥–µ–æ... {uploadProgress}%
              </p>
              {currentFile && (
                <p className="text-xs text-gray-500 mt-1">
                  {currentFile.name} ‚Ä¢ {formatFileSize(currentFile.size)}
                </p>
              )}
            </div>
          ) : (
            <button
              onClick={() => fileInputRef.current?.click()}
              className="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white px-6 py-3 rounded-lg font-medium transition-all duration-300 transform hover:scale-105 shadow-lg"
            >
              –í—ã–±—Ä–∞—Ç—å –≤–∏–¥–µ–æ—Ñ–∞–π–ª
            </button>
          )}

          <input
            ref={fileInputRef}
            type="file"
            accept="video/*"
            onChange={handleFileSelect}
            className="hidden"
          />

          <div className="mt-4 text-xs text-gray-500 bg-white rounded-lg p-3">
            <p className="font-medium text-gray-700 mb-1">‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:</p>
            <p>‚Ä¢ –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Safari –Ω–∞ iPhone</p>
            <p>‚Ä¢ –í–∏–¥–µ–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ –Ω–∞–≤—Å–µ–≥–¥–∞</p>
            <p>‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 2GB</p>
            <p>‚Ä¢ –§–æ—Ä–º–∞—Ç—ã: MP4, AVI, MOV, WMV, MKV</p>
          </div>
        </div>
      </div>
    </div>
  );
};

export default DirectVideoUploader;